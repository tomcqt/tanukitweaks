{"version":3,"sources":["webpack:///./app/javascript/packs/remote_interaction_helper.ts"],"names":["findTemplateLink","data","_findLink","findLink","rel","links","Array","find","link","template","href","isJRDLink","fetchInteractionURLSuccess","uri_or_domain","window","parent","postMessage","type","origin","fetchInteractionURLFailure","fromDomain","domain","fallbackTemplate","axios","get","params","resource","then","_ref","catch","fromAcct","acct","segments","replace","split","length","value","url","URL","hostname","isValidDomain","_ref3","fetchInteractionURL","test","host","_ref2","fromURL","includes","addEventListener","event","source"],"mappings":"4FAAA,2BAoBA,MAuBMA,EAAoBC,IAAa,IAAAC,EAAA,OACoB,OADpBA,EAftBC,EAACC,EAAaH,IAEX,iBAATA,GACE,OAATA,GACA,UAAWA,GACXA,EAAKI,iBAAiBC,MAEfL,EAAKI,MAAME,MACfC,GAhBYA,MACD,iBAATA,GACE,OAATA,KACA,QAASA,IACW,iBAAbA,EAAKJ,KACT,aAAcI,GAAkC,iBAAlBA,EAAKC,UACnC,SAAUD,GAA8B,iBAAdA,EAAKE,MAUHC,CAAUH,IAASA,EAAKJ,MAAQA,SAG7D,EAKFD,CAAS,0CAA2CF,SAAK,EAAzDC,EAA2DO,QAAQ,EAE/DG,EAA6BA,CACjCC,EACAJ,KAEAK,OAAOC,OAAOC,YACZ,CACEC,KAAM,8BACNJ,gBACAJ,YAEFK,OAAOI,OACR,EAGGC,EAA6BA,KACjCL,OAAOC,OAAOC,YACZ,CACEC,KAAM,+BAERH,OAAOI,OACR,EAUGE,EAAcC,IAClB,MAAMC,EAAoB,WAAUD,oCAEpCE,IACGC,IAAK,WAAUH,0BAAgC,CAC9CI,OAAQ,CAAEC,SAAW,WAAUL,OAEhCM,MAAKC,IAAe,IAAd,KAAE3B,GAAM2B,EACb,MAAMnB,EAAWT,EAAiBC,GAClCW,EAA2BS,EAAgB,MAARZ,IAAYa,EACzC,IAEPO,OAAM,KACLjB,EAA2BS,EAAQC,EAAiB,GACpD,EAuBAQ,EAAYC,IAGhB,MAAMC,GAFND,EAAOA,EAAKE,QAAQ,KAAM,KAEJC,MAAM,KAE5B,GAAwB,IAApBF,EAASG,SAAiBH,EAAS,KAjDlBI,KACrB,MAAMC,EAAM,IAAIC,IAAI,iBAEpB,OADAD,EAAIE,SAAWH,EACRC,EAAIE,WAAaH,CAAK,EA8CiBI,CAAcR,EAAS,IAEnE,YADAb,IAIF,MAAME,EAASW,EAAS,GAClBV,EAAoB,WAAUD,oCAEpCE,IACGC,IAAK,WAAUH,0BAAgC,CAC9CI,OAAQ,CAAEC,SAAW,QAAOK,OAE7BJ,MAAKc,IAAe,IAAd,KAAExC,GAAMwC,EACb,MAAMhC,EAAWT,EAAiBC,GAClCW,EAA2BmB,EAAc,MAARtB,IAAYa,EACvC,IAEPO,OAAM,KAELT,EAAWC,EAAO,GAClB,EAGAqB,EAAuB7B,IACL,KAAlBA,EACFM,IACS,eAAewB,KAAK9B,GAlDhBwB,KACf,MAAMhB,EAAS,IAAIiB,IAAID,GAAKO,KACtBtB,EAAoB,WAAUD,oCAEpCE,IACGC,IAAK,WAAUH,0BAAgC,CAC9CI,OAAQ,CAAEC,SAAUW,KAErBV,MAAKkB,IAAe,IAAd,KAAE5C,GAAM4C,EACb,MAAMpC,EAAWT,EAAiBC,GAClCW,EAA2ByB,EAAa,MAAR5B,IAAYa,EACtC,IAEPO,OAAM,KACLT,EAAWC,EAAO,GAClB,EAoCFyB,CAAQjC,GACCA,EAAckC,SAAS,KAChCjB,EAASjB,GAETO,EAAWP,EACb,EAGFC,OAAOkC,iBAAiB,WAAYC,IAG/BnC,OAAOI,QACRJ,OAAOC,SAAWkC,EAAMC,QACxBD,EAAM/B,SAAWJ,OAAOI,QAMxB+B,EAAMhD,MACgB,iBAAfgD,EAAMhD,MACb,SAAUgD,EAAMhD,MACI,wBAApBgD,EAAMhD,KAAKgB,MACX,kBAAmBgC,EAAMhD,MACW,iBAA7BgD,EAAMhD,KAAKY,eAElB6B,EAAoBO,EAAMhD,KAAKY,cACjC,G","file":"js/remote_interaction_helper-ed0733989bf14e44722a.chunk.js","sourcesContent":["/*\n\nThis script is meant to to be used in an `iframe` with the sole purpose of doing webfinger queries\nclient-side without being restricted by a strict `connect-src` Content-Security-Policy directive.\n\nIt communicates with the parent window through message events that are authenticated by origin,\nand performs no other task.\n\n*/\n\nimport './public-path';\n\nimport axios from 'axios';\n\ninterface JRDLink {\n  rel: string;\n  template?: string;\n  href?: string;\n}\n\nconst isJRDLink = (link: unknown): link is JRDLink =>\n  typeof link === 'object' &&\n  link !== null &&\n  'rel' in link &&\n  typeof link.rel === 'string' &&\n  (!('template' in link) || typeof link.template === 'string') &&\n  (!('href' in link) || typeof link.href === 'string');\n\nconst findLink = (rel: string, data: unknown): JRDLink | undefined => {\n  if (\n    typeof data === 'object' &&\n    data !== null &&\n    'links' in data &&\n    data.links instanceof Array\n  ) {\n    return data.links.find(\n      (link): link is JRDLink => isJRDLink(link) && link.rel === rel,\n    );\n  } else {\n    return undefined;\n  }\n};\n\nconst findTemplateLink = (data: unknown) =>\n  findLink('http://ostatus.org/schema/1.0/subscribe', data)?.template;\n\nconst fetchInteractionURLSuccess = (\n  uri_or_domain: string,\n  template: string,\n) => {\n  window.parent.postMessage(\n    {\n      type: 'fetchInteractionURL-success',\n      uri_or_domain,\n      template,\n    },\n    window.origin,\n  );\n};\n\nconst fetchInteractionURLFailure = () => {\n  window.parent.postMessage(\n    {\n      type: 'fetchInteractionURL-failure',\n    },\n    window.origin,\n  );\n};\n\nconst isValidDomain = (value: string) => {\n  const url = new URL('https:///path');\n  url.hostname = value;\n  return url.hostname === value;\n};\n\n// Attempt to find a remote interaction URL from a domain\nconst fromDomain = (domain: string) => {\n  const fallbackTemplate = `https://${domain}/authorize_interaction?uri={uri}`;\n\n  axios\n    .get(`https://${domain}/.well-known/webfinger`, {\n      params: { resource: `https://${domain}` },\n    })\n    .then(({ data }) => {\n      const template = findTemplateLink(data);\n      fetchInteractionURLSuccess(domain, template ?? fallbackTemplate);\n      return;\n    })\n    .catch(() => {\n      fetchInteractionURLSuccess(domain, fallbackTemplate);\n    });\n};\n\n// Attempt to find a remote interaction URL from an arbitrary URL\nconst fromURL = (url: string) => {\n  const domain = new URL(url).host;\n  const fallbackTemplate = `https://${domain}/authorize_interaction?uri={uri}`;\n\n  axios\n    .get(`https://${domain}/.well-known/webfinger`, {\n      params: { resource: url },\n    })\n    .then(({ data }) => {\n      const template = findTemplateLink(data);\n      fetchInteractionURLSuccess(url, template ?? fallbackTemplate);\n      return;\n    })\n    .catch(() => {\n      fromDomain(domain);\n    });\n};\n\n// Attempt to find a remote interaction URL from a `user@domain` string\nconst fromAcct = (acct: string) => {\n  acct = acct.replace(/^@/, '');\n\n  const segments = acct.split('@');\n\n  if (segments.length !== 2 || !segments[0] || !isValidDomain(segments[1])) {\n    fetchInteractionURLFailure();\n    return;\n  }\n\n  const domain = segments[1];\n  const fallbackTemplate = `https://${domain}/authorize_interaction?uri={uri}`;\n\n  axios\n    .get(`https://${domain}/.well-known/webfinger`, {\n      params: { resource: `acct:${acct}` },\n    })\n    .then(({ data }) => {\n      const template = findTemplateLink(data);\n      fetchInteractionURLSuccess(acct, template ?? fallbackTemplate);\n      return;\n    })\n    .catch(() => {\n      // TODO: handle host-meta?\n      fromDomain(domain);\n    });\n};\n\nconst fetchInteractionURL = (uri_or_domain: string) => {\n  if (uri_or_domain === '') {\n    fetchInteractionURLFailure();\n  } else if (/^https?:\\/\\//.test(uri_or_domain)) {\n    fromURL(uri_or_domain);\n  } else if (uri_or_domain.includes('@')) {\n    fromAcct(uri_or_domain);\n  } else {\n    fromDomain(uri_or_domain);\n  }\n};\n\nwindow.addEventListener('message', (event: MessageEvent<unknown>) => {\n  // Check message origin\n  if (\n    !window.origin ||\n    window.parent !== event.source ||\n    event.origin !== window.origin\n  ) {\n    return;\n  }\n\n  if (\n    event.data &&\n    typeof event.data === 'object' &&\n    'type' in event.data &&\n    event.data.type === 'fetchInteractionURL' &&\n    'uri_or_domain' in event.data &&\n    typeof event.data.uri_or_domain === 'string'\n  ) {\n    fetchInteractionURL(event.data.uri_or_domain);\n  }\n});\n"],"sourceRoot":""}